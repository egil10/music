<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>My Spotify Wrapped</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { 
        font-family: system-ui, Arial, sans-serif; 
        margin: 24px; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: white;
      }
      .wrap { 
        display: grid; 
        gap: 24px; 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 20px;
      }
      canvas { 
        max-width: 100%; 
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
      }
      .row { 
        display: grid; 
        grid-template-columns: 1fr; 
        gap: 24px; 
      }
      @media (min-width: 900px) { 
        .row { 
          grid-template-columns: 1fr 1fr; 
        } 
      }
      h1 {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      }
      h2 {
        margin-bottom: 15px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      }
      .chart-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        backdrop-filter: blur(10px);
      }
      select {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-size: 14px;
      }
      select option {
        background: #333;
        color: white;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
      }
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>ðŸŽµ My Spotify Wrapped</h1>
      
      <div class="stats" id="stats">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <div class="row">
        <div class="chart-container">
          <h2>ðŸ“Š Hours by Year</h2>
          <canvas id="hoursByYear"></canvas>
        </div>
        <div class="chart-container">
          <h2>ðŸŽ¤ Top Artists (latest year)</h2>
          <select id="yearSelect"></select>
          <canvas id="topArtists"></canvas>
        </div>
      </div>

      <div class="row">
        <div class="chart-container">
          <h2>ðŸŽµ Top Tracks (latest year)</h2>
          <select id="trackYearSelect"></select>
          <canvas id="topTracks"></canvas>
        </div>
        <div class="chart-container">
          <h2>ðŸ“ˆ Daily Listening Pattern</h2>
          <canvas id="dailyPattern"></canvas>
        </div>
      </div>
    </div>

         <script type="module">
       async function getJSON(url){ 
         try {
           const r = await fetch(url); 
           if (!r.ok) throw new Error(`HTTP ${r.status}`);
           return r.json(); 
         } catch (error) {
           console.error(`Failed to load ${url}:`, error);
           throw error;
         }
       }

       // Load all data with error handling
       try {
         const [summary, byYear, topArtistsByYear, topTracksByYear] = await Promise.all([
           getJSON("./data/summary.json"),
           getJSON("./data/listening_by_year.json"),
           getJSON("./data/top_artists_by_year.json"),
           getJSON("./data/top_tracks_by_year.json")
         ]);

         // Check if we have actual data
         if (!summary.total_plays || summary.total_plays === 0) {
        document.body.innerHTML = `
          <div style="text-align: center; padding: 50px; font-family: system-ui, Arial, sans-serif;">
            <h1>ðŸŽµ Spotify Wrapped Dashboard</h1>
            <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 10px; margin: 20px auto; max-width: 600px;">
              <h2>No Data Available</h2>
              <p>This is a demo deployment. To see your actual Spotify data:</p>
              <ol style="text-align: left; max-width: 400px; margin: 0 auto;">
                <li>Add your <code>merged_spotify_data.json</code> to the <code>raw/</code> directory</li>
                <li>Run <code>npm run build:data</code> locally</li>
                <li>Commit and push the updated <code>public/data/</code> files</li>
              </ol>
              <p style="margin-top: 20px;">
                <strong>Note:</strong> Large data files are kept local for privacy and never uploaded to GitHub.
              </p>
            </div>
          </div>
        `;
        return;
      }

      // Populate stats
      const statsContainer = document.getElementById("stats");
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${summary.total_hours.toLocaleString()}</div>
          <div class="stat-label">Total Hours</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${summary.total_plays.toLocaleString()}</div>
          <div class="stat-label">Total Plays</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${summary.years.length}</div>
          <div class="stat-label">Years of Data</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${(summary.total_hours / summary.total_plays * 60).toFixed(1)}</div>
          <div class="stat-label">Avg Minutes per Play</div>
        </div>
      `;

      const years = Object.keys(byYear).filter(y => y !== "unknown").sort();
      const hours = years.map(y => byYear[y].hours);

      // Hours by Year chart
      const ctx1 = document.getElementById("hoursByYear");
      new Chart(ctx1, {
        type: "bar",
        data: { 
          labels: years, 
          datasets: [{ 
            label: "Hours", 
            data: hours,
            backgroundColor: 'rgba(255, 255, 255, 0.3)',
            borderColor: 'rgba(255, 255, 255, 0.8)',
            borderWidth: 2
          }] 
        },
        options: { 
          responsive: true, 
          plugins: { legend: { display: false } },
          scales: {
            y: {
              ticks: { color: 'white' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            x: {
              ticks: { color: 'white' },
              grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
          }
        } 
      });

      // Top artists
      const yearSelect = document.getElementById("yearSelect");
      years.slice().reverse().forEach(y => {
        const opt = document.createElement("option");
        opt.value = y; opt.textContent = y;
        yearSelect.appendChild(opt);
      });

      const ctx2 = document.getElementById("topArtists");
      let topArtistsChart;

      function renderTopArtists(y){
        const data = (topArtistsByYear[y] || []).slice(0, 10);
        const labels = data.map(d => d.artist);
        const vals = data.map(d => d.hours);
        if (topArtistsChart) topArtistsChart.destroy();
        topArtistsChart = new Chart(ctx2, {
          type: "bar",
          data: { 
            labels, 
            datasets: [{ 
              label: "Hours", 
              data: vals,
              backgroundColor: 'rgba(255, 255, 255, 0.3)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2
            }] 
          },
          options: {
            responsive: true,
            indexAxis: "y",
            plugins: { legend: { display: false } },
            scales: { 
              x: { 
                ticks: { 
                  callback: v => v + "h",
                  color: 'white'
                },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
      }

      // Top tracks
      const trackYearSelect = document.getElementById("trackYearSelect");
      years.slice().reverse().forEach(y => {
        const opt = document.createElement("option");
        opt.value = y; opt.textContent = y;
        trackYearSelect.appendChild(opt);
      });

      const ctx3 = document.getElementById("topTracks");
      let topTracksChart;

      function renderTopTracks(y){
        const data = (topTracksByYear[y] || []).slice(0, 10);
        const labels = data.map(d => `${d.track} - ${d.artist}`);
        const vals = data.map(d => d.hours);
        if (topTracksChart) topTracksChart.destroy();
        topTracksChart = new Chart(ctx3, {
          type: "bar",
          data: { 
            labels, 
            datasets: [{ 
              label: "Hours", 
              data: vals,
              backgroundColor: 'rgba(255, 255, 255, 0.3)',
              borderColor: 'rgba(255, 255, 255, 0.8)',
              borderWidth: 2
            }] 
          },
          options: {
            responsive: true,
            indexAxis: "y",
            plugins: { legend: { display: false } },
            scales: { 
              x: { 
                ticks: { 
                  callback: v => v + "h",
                  color: 'white'
                },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              },
              y: {
                ticks: { color: 'white' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
              }
            }
          }
        });
      }

      // Daily pattern (simplified - just show last 30 days)
      const ctx4 = document.getElementById("dailyPattern");
      fetch("./data/listening_daily.csv")
        .then(r => r.text())
        .then(csv => {
          const lines = csv.split('\n').slice(1); // Skip header
          const last30Days = lines.slice(-30);
          const dates = last30Days.map(line => {
            const [date] = line.split(',');
            return new Date(date).toLocaleDateString();
          });
          const hours = last30Days.map(line => {
            const [, hours] = line.split(',');
            return parseFloat(hours);
          });

          new Chart(ctx4, {
            type: "line",
            data: { 
              labels: dates, 
              datasets: [{ 
                label: "Hours", 
                data: hours,
                borderColor: 'rgba(255, 255, 255, 0.8)',
                backgroundColor: 'rgba(255, 255, 255, 0.1)',
                borderWidth: 2,
                fill: true
              }] 
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  ticks: { color: 'white' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                  ticks: { color: 'white' },
                  grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
              }
            }
          });
        });

      // Initialize charts
      renderTopArtists(years.at(-1));
      renderTopTracks(years.at(-1));
      
      // Event listeners
      yearSelect.addEventListener("change", e => renderTopArtists(e.target.value));
      trackYearSelect.addEventListener("change", e => renderTopTracks(e.target.value));
       
     } catch (error) {
       console.error("Failed to load Spotify data:", error);
       document.body.innerHTML = `
         <div style="text-align: center; padding: 50px; font-family: system-ui, Arial, sans-serif;">
           <h1>ðŸŽµ Spotify Wrapped Dashboard</h1>
           <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 10px; margin: 20px auto; max-width: 600px;">
             <h2>Error Loading Data</h2>
             <p>Failed to load your Spotify data. This could be because:</p>
             <ul style="text-align: left; max-width: 400px; margin: 0 auto;">
               <li>The data files are not available yet</li>
               <li>There was a network error</li>
               <li>The deployment is still in progress</li>
             </ul>
             <p style="margin-top: 20px;">
               <strong>To fix this:</strong>
             </p>
             <ol style="text-align: left; max-width: 400px; margin: 0 auto;">
               <li>Add your <code>merged_spotify_data.json</code> to the <code>raw/</code> directory</li>
               <li>Run <code>npm run build:data</code> locally</li>
               <li>Commit and push the updated <code>public/data/</code> files</li>
             </ol>
             <p style="margin-top: 20px;">
               <strong>Note:</strong> Large data files are kept local for privacy and never uploaded to GitHub.
             </p>
           </div>
         </div>
       `;
     }
    </script>
  </body>
</html>
